!function(e){var n={};function t(o){if(n[o])return n[o].exports;var c=n[o]={i:o,l:!1,exports:{}};return e[o].call(c.exports,c,c.exports,t),c.l=!0,c.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var c in e)t.d(o,c,function(n){return e[n]}.bind(null,c));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";t.r(n);var o=function(){function e(e,n){this.localId=e,this.handler=n,n.setClient(this)}return e.prototype.connect=function(){var e=this,n=this.socket=new WebSocket("wss://smallvm.westeurope.cloudapp.azure.com:33713");n.onopen=function(){n.send(JSON.stringify({type:"connected",id:e.localId}))},n.onerror=function(e){console.log("WebSocket Error "+e),n.close()},n.onclose=function(n){console.log("Socket is closed. Reconnect will be attempted in 1 second.",n.reason),setTimeout((function(){e.connect()}),1e3)},n.onmessage=function(n){var t=JSON.parse(n.data);switch(t.type){case"peers":for(var o=0,c=t.peers;o<c.length;o++){var r=c[o];e.handler.connectToPeer(r)}break;case"offer":var i=t.connectionId,a=t.offeringPeer,s=t.offer;e.handler.acceptOffer(i,a,s);break;case"accept":i=t.connectionId;var d=t.accept;e.handler.acceptAccept(i,d);break;case"new_ice_candidate":i=t.connectionId;var l=t.candidate;e.handler.addRemoteCandidate(i,l);break;case"client_left":var u=t.id;e.handler.peerDisconnected(u)}}},e.prototype.sendIceCandidate=function(e,n){this.socket.send(JSON.stringify({type:"new_ice_candidate",candidate:e,id:this.localId,connectionId:n}))},e.prototype.sendOffer=function(e,n,t){this.socket.send(JSON.stringify({type:"offer",connectionId:e,offer:n,offeringPeer:this.localId,acceptingPeer:t}))},e.prototype.sendAccept=function(e,n,t){this.socket.send(JSON.stringify({type:"accept",connectionId:e,accept:n,offeringPeer:t,acceptingPeer:this.localId}))},e}();function c(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}))}var r=function(){function e(e,n){this.localId=e,this.peerHandler=n,this.connections={}}return e.prototype.setClient=function(e){this.client=e},e.prototype.addRemoteCandidate=function(e,n){this.connections[e].rtcConnection.addIceCandidate(n)},e.prototype.findConnectionTo=function(e){for(var n in this.connections)if(this.connections[n].acceptingPeer===e||this.connections[n].offeringPeer===e)return n;return null},e.prototype.peerDisconnected=function(e){var n=this.findConnectionTo(e);this.connections[n].rtcConnection.close(),delete this.connections[n]},e.prototype.connectToPeer=function(e){if(null==this.findConnectionTo(e)){var n=c(),t=this,o=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]}),r=this.connections[n]={rtcConnection:o,offeringPeer:this.localId,acceptingPeer:e,channel:o.createDataChannel("sendChannel")};r.channel.onmessage=function(n){t.peerHandler.onMessage(e,n.data,r.channel)},r.channel.onopen=function(){t.peerHandler.onPeerReady(e,r.channel)},r.channel.onclose=function(){},o.onicecandidate=function(e){var o=e.candidate;o&&t.client.sendIceCandidate(o,n)},o.createOffer().then((function(c){t.client.sendOffer(n,c,e),o.setLocalDescription(c)}))}else console.warn("already connected to "+e)},e.prototype.acceptOffer=function(e,n,t){var o=this,c=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]}),r=this.connections[e]={rtcConnection:c,offeringPeer:n,acceptingPeer:this.localId,channel:null};c.ondatachannel=function(e){var t=r.channel=e.channel;t.onmessage=function(e){o.peerHandler.onMessage(n,e.data,t)},t.onopen=function(){o.peerHandler.onPeerReady(n,t)},t.onclose=function(){}},c.onicecandidate=function(n){var t=n.candidate;t&&o.client.sendIceCandidate(t,e)},c.setRemoteDescription(t).then((function(){c.createAnswer().then((function(t){o.client.sendAccept(e,t,n),c.setLocalDescription(t)}))}))},e.prototype.acceptAccept=function(e,n){this.connections[e].rtcConnection.setRemoteDescription(n)},e.prototype.broadcast=function(e){for(var n in this.connections){var t=this.connections[n];null!=t.channel&&"open"==t.channel.readyState&&t.channel.send(e)}},e}(),i=function(){return(i=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++)for(var c in n=arguments[t])Object.prototype.hasOwnProperty.call(n,c)&&(e[c]=n[c]);return e}).apply(this,arguments)};t.d(n,"DefaultPeerHandler",(function(){return p}));var a=c(),s=localStorage.getItem("clientId");null==s&&(s=c(),localStorage.setItem("clientId",s));var d={clientStates:{},sources:[]};d.clientStates[s]={},d.sources=[{id:s,latestTimestamp:0}];var l=document.createElement("pre");function u(){l.innerHTML=JSON.stringify(d,null,4)}u();var p=function(){function e(){}return e.prototype.onPeerReady=function(e,n){n.send(JSON.stringify({type:"sources",id:s,sources:d.sources}))},e.prototype.onMessage=function(e,n,t){var o=JSON.parse(n);switch(o.type){case"sources":var c=function(e,n){for(var t=n.sources.map((function(n){var t=e.find((function(e){return e.id===n.id}));return{local:n,hasUpdates:!t||n.latestTimestamp>t.latestTimestamp,remoteTimestamp:t?t.latestTimestamp:0}})).filter((function(e){return e.hasUpdates})),o={messages:[],sources:t.map((function(e){return e.local}))},c=0,r=t;c<r.length;c++){var i=r[c],a=i.local,s=i.remoteTimestamp,d=n.clientStates[a.id];for(var l in d){var u=d[l];u.timestamp>s&&o.messages.push(u)}}return o}(o.sources,d);t.send(JSON.stringify({type:"updates",id:s,updates:c}));break;case"updates":!function(e,n){for(var t=e.sources.filter((function(e){return!n.sources.some((function(n){return n.id===e.id}))})),o=0,c=t;o<c.length;o++){var r=c[o];n.clientStates[r.id]={}}for(var a=0,s=e.messages;a<s.length;a++){var d=s[a],l=n.clientStates[d.sourceId][d.id];l?l.timestamp>=d.timestamp?console.error("old update provided"):(l.timestamp=d.timestamp,l.content=d.content):n.clientStates[d.sourceId][d.id]=d}n.sources=n.sources.map((function(n){var t=e.sources.find((function(e){return n.id===e.id})),o=Math.max(n.latestTimestamp,t?t.latestTimestamp:0);return i(i({},n),{latestTimestamp:o})}));for(var u=0,p=t;u<p.length;u++){r=p[u];n.sources.push(r)}}(c=o.updates,d),u()}},e}(),f=new r(a,new p);new o(a,f).connect();var m=document.createElement("div");m.innerHTML="I am "+s,document.body.appendChild(m);var h=document.createElement("input");document.body.appendChild(h);var y=document.createElement("button");document.body.appendChild(y),y.innerHTML="Add",y.onclick=function(){var e,n=c(),t=d.clientStates[s][n]={id:n,content:h.value,sourceId:s,timestamp:(e=d.sources.find((function(e){return e.id==s})),e.latestTimestamp++,e.latestTimestamp)},o={messages:[t],sources:[{id:s,latestTimestamp:t.timestamp}]};f.broadcast(JSON.stringify({type:"updates",id:s,updates:o})),u()},document.body.appendChild(l)}]);