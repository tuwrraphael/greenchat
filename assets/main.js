!function(e){var n={};function t(o){if(n[o])return n[o].exports;var c=n[o]={i:o,l:!1,exports:{}};return e[o].call(c.exports,c,c.exports,t),c.l=!0,c.exports}t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var c in e)t.d(o,c,function(n){return e[n]}.bind(null,c));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="/assets/",t(t.s=0)}([function(e,n,t){"use strict";t.r(n);var o={iceServers:[{urls:["turn:hub.greenchat.me:3478"],username:"raphael",credential:"@123@test@"}]},c=function(){function e(e,n){this.localId=e,this.handler=n,n.setClient(this)}return e.prototype.connect=function(){var e=this,n=this.socket=new WebSocket("wss://hub.greenchat.me");n.onopen=function(){n.send(JSON.stringify({type:"connected",id:e.localId}))},n.onerror=function(e){console.log("WebSocket Error "+e),n.close()},n.onclose=function(n){console.log("Socket is closed. Reconnect will be attempted in 1 second.",n.reason),setTimeout((function(){e.connect()}),1e3)},n.onmessage=function(n){var t=JSON.parse(n.data);switch(t.type){case"peers":for(var o=0,c=t.peers;o<c.length;o++){var r=c[o];e.handler.connectToPeer(r)}break;case"offer":var i=t.connectionId,a=t.offeringPeer,s=t.offer;e.handler.acceptOffer(i,a,s);break;case"accept":i=t.connectionId;var d=t.accept;e.handler.acceptAccept(i,d);break;case"new_ice_candidate":i=t.connectionId;var u=t.candidate;e.handler.addRemoteCandidate(i,u);break;case"client_left":var l=t.id;e.handler.peerDisconnected(l)}}},e.prototype.sendIceCandidate=function(e,n){this.socket.send(JSON.stringify({type:"new_ice_candidate",candidate:e,id:this.localId,connectionId:n}))},e.prototype.sendOffer=function(e,n,t){this.socket.send(JSON.stringify({type:"offer",connectionId:e,offer:n,offeringPeer:this.localId,acceptingPeer:t}))},e.prototype.sendAccept=function(e,n,t){this.socket.send(JSON.stringify({type:"accept",connectionId:e,accept:n,offeringPeer:t,acceptingPeer:this.localId}))},e}();function r(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}))}var i=function(){return(i=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++)for(var c in n=arguments[t])Object.prototype.hasOwnProperty.call(n,c)&&(e[c]=n[c]);return e}).apply(this,arguments)},a=function(){function e(e,n){this.localId=e,this.peerHandler=n,this.connections={}}return e.prototype.setClient=function(e){this.client=e},e.prototype.addRemoteCandidate=function(e,n){this.connections[e].rtcConnection.addIceCandidate(n)},e.prototype.findConnectionTo=function(e){for(var n in this.connections)if(this.connections[n].acceptingPeer===e||this.connections[n].offeringPeer===e)return n;return null},e.prototype.peerDisconnected=function(e){var n=this.findConnectionTo(e);this.connections[n].rtcConnection.close(),delete this.connections[n]},e.prototype.connectToPeer=function(e){if(null==this.findConnectionTo(e)){var n=r(),t=this,c=new RTCPeerConnection(i({},o)),a=this.connections[n]={rtcConnection:c,offeringPeer:this.localId,acceptingPeer:e,channel:c.createDataChannel("sendChannel")};a.channel.onmessage=function(n){t.peerHandler.onMessage(e,n.data,a.channel)},a.channel.onopen=function(){t.peerHandler.onPeerReady(e,a.channel)},a.channel.onclose=function(){},c.onicecandidate=function(e){var o=e.candidate;o&&t.client.sendIceCandidate(o,n)},c.createOffer().then((function(o){t.client.sendOffer(n,o,e),c.setLocalDescription(o)}))}else console.warn("already connected to "+e)},e.prototype.acceptOffer=function(e,n,t){var c=this,r=new RTCPeerConnection(i({},o)),a=this.connections[e]={rtcConnection:r,offeringPeer:n,acceptingPeer:this.localId,channel:null};r.ondatachannel=function(e){var t=a.channel=e.channel;t.onmessage=function(e){c.peerHandler.onMessage(n,e.data,t)},t.onopen=function(){c.peerHandler.onPeerReady(n,t)},t.onclose=function(){}},r.onicecandidate=function(n){var t=n.candidate;t&&c.client.sendIceCandidate(t,e)},r.setRemoteDescription(t).then((function(){r.createAnswer().then((function(t){c.client.sendAccept(e,t,n),r.setLocalDescription(t)}))}))},e.prototype.acceptAccept=function(e,n){this.connections[e].rtcConnection.setRemoteDescription(n)},e.prototype.broadcast=function(e){for(var n in this.connections){var t=this.connections[n];null!=t.channel&&"open"==t.channel.readyState&&t.channel.send(e)}},e}(),s=function(){return(s=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++)for(var c in n=arguments[t])Object.prototype.hasOwnProperty.call(n,c)&&(e[c]=n[c]);return e}).apply(this,arguments)};t.d(n,"DefaultPeerHandler",(function(){return h}));var d=r(),u=localStorage.getItem("clientId");null==u&&(u=r(),localStorage.setItem("clientId",u));var l={clientStates:{},sources:[]};l.clientStates[u]={},l.sources=[{id:u,latestTimestamp:0}];var p=document.createElement("pre");function f(){p.innerHTML=JSON.stringify(l,null,4)}f();var h=function(){function e(){}return e.prototype.onPeerReady=function(e,n){n.send(JSON.stringify({type:"sources",id:u,sources:l.sources}))},e.prototype.onMessage=function(e,n,t){var o=JSON.parse(n);switch(o.type){case"sources":var c=function(e,n){for(var t=n.sources.map((function(n){var t=e.find((function(e){return e.id===n.id}));return{local:n,hasUpdates:!t||n.latestTimestamp>t.latestTimestamp,remoteTimestamp:t?t.latestTimestamp:0}})).filter((function(e){return e.hasUpdates})),o={messages:[],sources:t.map((function(e){return e.local}))},c=0,r=t;c<r.length;c++){var i=r[c],a=i.local,s=i.remoteTimestamp,d=n.clientStates[a.id];for(var u in d){var l=d[u];l.timestamp>s&&o.messages.push(l)}}return o}(o.sources,l);t.send(JSON.stringify({type:"updates",id:u,updates:c}));break;case"updates":!function(e,n){for(var t=e.sources.filter((function(e){return!n.sources.some((function(n){return n.id===e.id}))})),o=0,c=t;o<c.length;o++){var r=c[o];n.clientStates[r.id]={}}for(var i=0,a=e.messages;i<a.length;i++){var d=a[i],u=n.clientStates[d.sourceId][d.id];u?u.timestamp>=d.timestamp?console.error("old update provided"):(u.timestamp=d.timestamp,u.content=d.content):n.clientStates[d.sourceId][d.id]=d}n.sources=n.sources.map((function(n){var t=e.sources.find((function(e){return n.id===e.id})),o=Math.max(n.latestTimestamp,t?t.latestTimestamp:0);return s(s({},n),{latestTimestamp:o})}));for(var l=0,p=t;l<p.length;l++){r=p[l];n.sources.push(r)}}(c=o.updates,l),f()}},e}(),m=new a(d,new h);new c(d,m).connect();var y=document.createElement("div");y.innerHTML="I am "+u,document.body.appendChild(y);var v=document.createElement("input");document.body.appendChild(v);var g=document.createElement("button");document.body.appendChild(g),g.innerHTML="Add",g.onclick=function(){var e,n=r(),t=l.clientStates[u][n]={id:n,content:v.value,sourceId:u,timestamp:(e=l.sources.find((function(e){return e.id==u})),e.latestTimestamp++,e.latestTimestamp)},o={messages:[t],sources:[{id:u,latestTimestamp:t.timestamp}]};m.broadcast(JSON.stringify({type:"updates",id:u,updates:o})),f()},document.body.appendChild(p)}]);